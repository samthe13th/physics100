<html>

<head></head>

<body>
    <h1>Rotating Disks</h1>
    <div id="stage"></div>
</body>

</html>
<script src="../../js/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type='text/javascript' src="../../js/raphael.min.js"></script>
<script>
    window.dragging = null;
    var openslot = null;
    var paper = Raphael("stage", 400, 400);
    var s1 = Slot(200, 250, 120, "s1");
    var params = {
        radius: 40
    }
    openslot = s1;
    var disks = {
        d1: Disk(100, 60, params.radius, "red"),
        d2: Disk(200, 60, params.radius, "blue"),
        d3: Disk(300, 60, params.radius, "green")
    }
    disks.d1.id = "d1";
    disks.d2.id = "d2";
    disks.d3.id = "d3";
    function Slot(x, y, r, id) {
        var slot = paper.circle(x, y, r)
            .attr({
                "stroke": "lightgrey",
                "fill": "white",
                "stroke-width": "10px"
            })
        slot.rx = x;
        slot.ry = y;
        slot.r = r;
        slot.id = id;
        return slot;
    }
    function Disk(x, y, r, color) {
        var base = paper.circle(x, y, r)
            .attr({
                "fill": "white",
                "stroke": "lightgrey",
                "stroke-width": "4px"
            })
        var axis = paper.circle(x, y, 5)
            .attr({
                "fill": "lightgrey",
                "stroke": "none"
            })
        var mark = paper.circle((x + (r - 10)), y, 10)
            .attr({
                "fill": color,
                "stroke": "none"
            })
        var disk = paper.set();
        disk.color = color;
        disk.base = base;
        disk.axis = axis;
        disk.mark = mark;
        disk.push(base);
        disk.push(axis);
        disk.push(mark);
        disk.angle = 0;
        disk.ox = x;
        disk.oy = y;
        disk.x = x;
        disk.y = y;
        disk.slot = null;
        disk.speed = 0;
        disk.update = function () {
            if (disk.speed !== 0 && !window.dragging) {
                disk.angle += disk.speed;
                if (Math.abs(disk.angle) > 360) {
                    disk.angle = 0;
                }
            }
            disk.transform([("T" + (disk.x - disk.ox)), (disk.y - disk.oy), ("R" + disk.angle), disk.x, disk.y]);
        }
        disk.mouseover(function () {
            $("body").css("cursor", "pointer");
            disk.base.attr("stroke", color);
            console.log("disk.x: " + disk.x + "disk.y: " + disk.y);
        })
        disk.mouseout(function () {
            $("body").css("cursor", "default");
            disk.base.attr("stroke", "lightgrey");
        })
        disk.mousedown(function () {
            window.dragging = disk;
            disk.update();
            disk.toFront();
        })
        return disk
    }
    disks.d1.speed = 10;
    disks.d2.speed = -7;
    disks.d3.speed = -3;
    setInterval(function () {
        for (var d in disks) {
            disks[d].update();
        }
    }, 20);
    $("#stage").mousemove(function (e) {
        if (window.dragging) {
            var newx = (e.pageX - paper.canvas.parentNode.offsetLeft);
            var newy = (e.pageY - paper.canvas.parentNode.offsetTop);
            checkCollisions(newx, newy);
            if (!window.dragging.slot) {
                window.dragging.x = newx;
                window.dragging.y = newy;
            }
        }
    })
    function checkCollisions(mx, my) {
        if (openslot) {
            var dx = Math.abs(openslot.rx - mx);
            var dy = Math.abs(openslot.ry - my);
            var dist = Math.sqrt((Math.pow(dx, 2) + (Math.pow(dy, 2))))
            if (dist < openslot.r) {
                openslot.attr({
                    "stroke": window.dragging.color
                });
                fit(window.dragging, openslot);
                //  openslot = null;
            } else if (window.dragging.slot) {
                pop(mx, my, window.dragging)
                openslot.attr({
                    "stroke": "lightgrey"
                });
                window.dragging.slot = null;
                //openslot = window.dragging.slot;
            }
        }
    }
    $(window).mouseup(function () {
        console.log("up");
        window.dragging = null;
    });
    function fit(disk, slot) {
        var scaled = Disk(openslot.rx, openslot.ry, openslot.r, disk.color);
       // scaled.transform([("T" + openslot.rx), openslot.ry]);
        scaled.speed = disk.speed;
        scaled.id = disk.id;
        scaled.slot = slot;
        disks[disk.id] = scaled;
        disk.remove();
        window.dragging = scaled;
    }
    function pop(mx, my, disk) {
        var revert = Disk(mx, my, params.radius, disk.color);
        revert.transform([("T" + mx, my)]);
        revert.speed = disk.speed;
        revert.id = disk.id;
        openslot = disk.slot;
        disks[disk.id] = revert;
        disk.remove();
        window.dragging = revert;
    }

</script>
<style>
    #stage {
        position: relative;
        left: 100px;
        border-style: solid;
        border-color: lightgrey;
        width: 400px;
        height: 400px;
    }
</style>